<!doctype html>
<html>

<head>
	<title>cosmoz-data-nav-resizable</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
	<script src="../../web-component-tester/browser.js"></script>
	<script src="../../test-fixture/test-fixture-mocha.js"></script>

	<link rel="import" href="../../polymer/lib/elements/custom-style.html">

	<link rel="import" href="../../test-fixture/test-fixture.html">
	<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
	<link rel="import" href="../cosmoz-data-nav.html">
	<link rel="import" href="./helpers/cosmoz-data-nav-test-view.html">
	<link rel="import" href="./helpers/cosmoz-data-nav-resizable-view.html">

	<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
	<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">

	<custom-style>
		<style include="iron-flex iron-positioning">
			cosmoz-data-nav {
				display: block;
				width: 455px;
				height: 400px;
				position: relative;
			}
		</style>
	</custom-style>
</head>

<body>
	<test-fixture id="resizable">
		<template>
			<cosmoz-data-nav>
				<template>
					<!-- <cosmoz-data-nav-test-view class="fit layout vertical" item="{{ item }}" index="[[ index ]]"></cosmoz-data-nav-test-view> -->
					<cosmoz-data-nav-resizable-view class="fit layout vertical" item="{{ item }}" index="[[ index ]]"></cosmoz-data-nav-resizable-view>
				</template>
			</cosmoz-data-nav>
		</template>
	</test-fixture>

	<script>
		/*global sinon chai flush */
		(function () {
			'use strict';

			sinon.assert.expose(chai.assert, { prefix: '' });

			const whenFirstElementsRenderer = (nav, done) => {
				let listener;
				nav.addEventListener('iron-request-resize-notifications', listener = () => {
					const rendered = nav._elements.filter(e => e.__instance != null && e.__incomplete != null);
					if (rendered.length === nav.elementsBuffer) {
						nav.removeEventListener('iron-request-resize-notifications', listener);
						done();
					}
				});
			};

			suite('resizable', () => {
				let nav;

				setup(done => {
					nav = fixture('resizable');
					nav.items = Array(10).fill('').map((e, i) => i.toString());
					if (nav._templatesObserver.flush) {
						nav._templatesObserver.flush();
					} else {
						Polymer.dom.flush();
					}
					done();
				});

				test('instantiates a cosmoz-data-nav element', () => {
					assert.equal(nav.is, 'cosmoz-data-nav');
				});

				test('resize', done => {
					whenFirstElementsRenderer(nav, () => {
						const view = nav._elements[0].querySelector('cosmoz-data-nav-resizable-view'),
							spy = sinon.spy(view, '_onIronResize');
						nav.notifyResize();
						assert.calledOnce(spy);
						assert.equal(nav._interestedResizables.length, 6);
						assert.isTrue(nav.resizerShouldNotify(view));
						spy.restore();
						done();
					});

					nav.setItemById('0', { id: 0 });
					nav.setItemById('1', { id: 1 });
					nav.setItemById('2', { id: 2 });

				});
			});
		}());
	</script>
</body>

</html>