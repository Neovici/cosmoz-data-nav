<!doctype html>
<html>
<head>
	<title>cosmoz-data-nav-basic</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
	<script src="../../web-component-tester/browser.js"></script>
	<script src="../../test-fixture/test-fixture-mocha.js"></script>

	<link rel="import" href="../../test-fixture/test-fixture.html">
	<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
	<link rel="import" href="../cosmoz-data-nav.html">
	<link rel="import" href="./helpers/cosmoz-data-nav-test-view.html">

	<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
	<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

	<custom-style>
		<style is="custom-style" include="iron-flex iron-positioning">
			cosmoz-data-nav {
				display: block;
				width: 455px;
				height: 400px;
				position: relative;
			}
		</style>
	</custom-style>
</head><body>
	<test-fixture id="defaults">
		<template>
			<cosmoz-data-nav>
				<template>
					<cosmoz-data-nav-test-view class="fit layout vertical" item="{{ item }}" index="[[ index ]]"></cosmoz-data-nav-test-view>
				</template>
			</cosmoz-data-nav>
		</template>
	</test-fixture>

	<script>
	(function () {
		'use strict';

		suite('defaults', function () {
			var nav;

			setup(function (done) {
				nav = fixture('defaults');
				nav.items = Array(20).fill('').map((e, i) => i.toString());
				nav._templatesObserver.flush ? nav._templatesObserver.flush() : Polymer.dom.flush();
				nav._initSteps.splice(0).forEach((s)=>s.call());
				done();
			});

			test('instantiates a cosmoz-data-nav element', function () {
				assert.equal(nav.is, 'cosmoz-data-nav');
			});


			test('creates buffer elements', function(){
				assert.lengthOf(nav._elements, nav.elementsBuffer);
			});

			test('has template for elements', function(){
				const template = nav.$.templatesSlot.querySelector('template');
				assert.equal(template, nav._elementsTemplate);
			});

			test('has template for incomplete elements', function(){

			});

			test('buffer elements have incomplete content', function () {
				nav._elements.forEach( element => assert.isNotNull(element.__incomplete));
			});

			test('buffer elements are not templatized without complete data', function(){
				nav._elements.forEach( element => assert.isUndefined(element.__instance));
			});

			test('selects first element', function () {
				assert.equal(nav.selected, 0);
				const selectedEl = nav._getElement(nav.selected);
				assert.include(nav._elements, selectedEl);
			});
		});

		suite('properties check', function () {
			var nav;

			setup(function (done) {
				nav = fixture('defaults');
				nav.items = Array(20).fill('').map((e, i) => i.toString());
				if (nav._templatesObserver.flush) {
					nav._templatesObserver.flush();
				} else {
					Polymer.dom.flush();
				}
				nav._initSteps.splice(0).forEach(s => s.call());
				done();
			});

			test('selected property is updated', function () {
				nav.select(1);
				assert.equal(nav.selected, 1, 'Expected the index of selected item to be 1');
				nav.select(3);
				assert.equal(nav.selected, 3, 'Expected the index of selected item to be 3');
				nav.select(7);
				assert.equal(nav.selected, 7, 'Expected the index of selected item to be 7');
				nav.select(2);
				assert.equal(nav.selected, 2, 'Expected the index of selected item to be 2');
			});

			test('selectedNext is updated', function () {
				nav.select(13);
				assert.equal(nav.selectedNext, 14);
				nav.select(2);
				assert.equal(nav.selectedNext, 3);
				nav.select(7);
				assert.equal(nav.selectedNext, 8);
				nav.select(0);
				assert.equal(nav.selectedNext, 1);
			});

			test('queueLength returns the length of items array', function () {
				assert.equal(nav.queueLength, 20);
			});

			test('reverse property is working', function () {
				nav.select(5);
				assert.isFalse(nav.reverse);
				nav.select(15);
				assert.isFalse(nav.reverse);
				nav.select(5);
				assert.isTrue(nav.reverse);
				nav.select(2);
				assert.isTrue(nav.reverse);
				nav.select(3);
				assert.isFalse(nav.reverse);
			});
		});

		suite('cache', function () {
			var nav;

			setup(function (done) {
				nav = fixture('defaults');
				nav.items = Array(20).fill('').map((e, i) => i.toString());
				if (nav._templatesObserver.flush) {
					nav._templatesObserver.flush();
				} else {
					Polymer.dom.flush();
				}
				nav._initSteps.splice(0).forEach(s => s.call());
				done();
			});

			test('cache stores one item', function (done) {
				nav.setItemById('1', { id: 88 });
				Polymer.Base.async(function () {
					let cache = nav._cache;
					assert.equal(cache['1'].id, 88);
					done();
				}, 70);
			});

			test('cache stores two items', function (done) {
				nav.setItemById('1', { id: 88 });
				nav.setItemById('2', { id: 99 });
				Polymer.Base.async(function () {
					let cache = nav._cache;
					assert.equal(cache['1'].id, 88);
					assert.equal(cache['2'].id, 99);
					done();
				}, 50);
			});

			test('clearCache method works', function (done) {
				nav.setItemById('1', { id: 1 });
				nav.setItemById('2', { id: 2 });
				Polymer.Base.async(function () {
					let cache = nav._cache;
					assert.equal(cache['1'].id, 1);
					assert.equal(cache['2'].id, 2);
					nav.clearCache();
					assert.deepEqual(nav._cache, {});
					done();
				}, 70);
			});

			test('removeFromCache method works', function (done) {
				nav.setItemById('1', { id: 88 });
				nav.setItemById('2', { id: 99 });
				nav.setItemById('3', { id: 11 });
				Polymer.Base.async(function () {
					let cache = nav._cache;
					assert.equal(cache['1'].id, 88);
					assert.equal(cache['2'].id, 99);
					assert.equal(cache['3'].id, 11);

					nav.removeFromCache(cache['2']);
					assert.isUndefined(nav._cache['2']);
					assert.equal(Object.keys(nav._cache).length, 2);
					nav.removeFromCache(cache['1']);
					assert.isUndefined(nav._cache['1']);
					assert.equal(Object.keys(nav._cache).length, 1);
					done();
				}, 50);
			});
		});

		suite('other methods', function () {
			var nav;

			setup(function (done) {
				nav = fixture('defaults');
				nav.items = Array(20).fill('').map((e, i) => i.toString());
				if (nav._templatesObserver.flush) {
					nav._templatesObserver.flush();
				} else {
					Polymer.dom.flush();
				}
				nav._initSteps.splice(0).forEach(s => s.call());
				done();
			});

			test('isIncompleteFn checks if an item is incomplete', function (done) {
				assert.isTrue(nav.isIncompleteFn());
				assert.isTrue(nav.isIncompleteFn(null));
				assert.isFalse(nav.isIncompleteFn({id: '1'}));

				nav.setItemById('1', { id: 1 });
				Polymer.Base.async(function () {
					assert.isTrue(nav.isIncompleteFn(nav.items[0]));
					assert.isFalse(nav.isIncompleteFn(nav.items[1]));
					done();
				}, 70);
			});

			test('setItemById works', function (done) {
				nav.setItemById('0', { id: 77 });
				Polymer.Base.async(function () {
					let view = nav._elements[0].querySelector('cosmoz-data-nav-test-view'),
						content = view.$$('div.flex');
					assert.equal(content.innerText, 77);
					done();
				}, 300);
			});

			test('selectById updates selected property', function () {
				nav.setItemById('0', { id: 0 });
				nav.setItemById('14', { id: 14 });
				nav.setItemById('2', { id: 2 });
				nav.setItemById('9', { id: 9 });
				nav.setItemById('17', { id: 17 });
				nav.selectById(2);
				assert.equal(nav.selected, 2);
				nav.selectById(14);
				assert.equal(nav.selected, 14);
				nav.selectById(0);
				assert.equal(nav.selected, 0);
				nav.selectById(17);
				assert.equal(nav.selected, 17);
			});

			test('preloads data', function (done) {
				const data = {id: '0'};
				assert.isTrue(nav.isIncompleteFn(nav.items[0]));
				assert.equal(nav._preloadIdx, 0);

				nav.setItemById('0', data);
				Polymer.Base.async(function () {
					assert.equal(nav._preloadIdx, 1);
					assert.isFalse(nav.isIncompleteFn(nav.items[0]));
					assert.deepEqual(nav.items[0], data);
					done();
				}, 400);

			});
		});
	}());
	</script>
</body></html>
